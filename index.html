<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNISP</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; margin: 0; padding: 20px; }
        #reader { width: 100%; max-width: 500px; margin: auto; border-radius: 15px; overflow: hidden; border: 2px solid #333; }
        #result { margin-top: 20px; padding: 20px; border-radius: 15px; min-height: 100px; display: none; }
        .attivo { background: #2e7d32; border: 4px solid #4caf50; }
        .inattivo { background: #c62828; border: 4px solid #f44336; animation: blink 1s infinite; }
        h1 { color: #fff; font-size: 1.5rem; }
        .member-name { font-size: 2rem; font-weight: bold; margin-bottom: 10px; }
        .status-text { font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        #loading { color: #888; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1>UNISP-SCAN</h1>
    <div id="loading">Chargement de la base de données...</div>
    
    <div id="reader"></div>

    <div id="result">
        <div class="member-name" id="nameDisplay"></div>
        <div class="status-text" id="statusDisplay"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // REMPLACEZ LE LIEN CI-DESSOUS PAR VOTRE LIEN CSV PUBLIÉ SUR LE WEB
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSc3LZw98cFyqm2XGSEYYF3IOf5fHB3Pff8vLLlCD-VgvIicvX6jYWH-QDSbn5dZvpPhHjrXoIH4Hu9/pub?gid=0&single=true&output=csv'; 
        
        let membersData = [];

        // 1. Charger les données depuis Google Sheets
        function loadDatabase() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    membersData = results.data;
                    document.getElementById('loading').innerText = "✅ Base de données prête (" + membersData.length + " membres)";
                    startScanner();
                }
            });
        }

        // 2. Lancer le scanner de caméra
        function startScanner() {
            const html5QrCode = new html5QrCode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            );
        }

        // 3. Action quand un QR est détecté
        function onScanSuccess(decodedText) {
            // Chercher le membre dans la colonne 'Codice_QR'
            const member = membersData.find(m => m.Codice_QR.trim() === decodedText.trim());
            const resultDiv = document.getElementById('result');
            
            resultDiv.style.display = 'block';

            if (member) {
                document.getElementById('nameDisplay').innerText = member.Nome + " " + member.Cognome;
                const status = member.Stato.toUpperCase();
                document.getElementById('statusDisplay').innerText = status;

                if (status === "ATTIVO") {
                    resultDiv.className = 'attivo';
                } else {
                    resultDiv.className = 'inattivo';
                    // Alerte sonore pour Inactif (optionnel)
                    window.navigator.vibrate(500);
                }
            } else {
                resultDiv.className = '';
                resultDiv.style.background = '#333';
                document.getElementById('nameDisplay').innerText = "INCONNU";
                document.getElementById('statusDisplay').innerText = "Code: " + decodedText;
            }
        }

        window.onload = loadDatabase;
    </script>
</body>
</html>