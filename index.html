<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNISP</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; margin: 0; padding: 20px; }
        #reader { width: 100%; max-width: 500px; margin: auto; border-radius: 15px; overflow: hidden; border: 2px solid #333; }
        #result { margin-top: 20px; padding: 20px; border-radius: 15px; min-height: 100px; display: none; }
        .attivo { background: #2e7d32; border: 4px solid #4caf50; }
        .inattivo { background: #c62828; border: 4px solid #f44336; animation: blink 1s infinite; }
        h1 { color: #fff; font-size: 1.5rem; }
        .member-name { font-size: 2rem; font-weight: bold; margin-bottom: 10px; }
        .status-text { font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; }
        .passage-info { margin-top: 10px; font-style: italic; color: #ffeb3b; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        #loading { color: #888; margin-bottom: 10px; }
        #startBtn { padding: 15px; font-size: 18px; margin-bottom: 20px; border-radius: 10px; cursor: pointer; background: #2196f3; color: white; border: none; }
    </style>
</head>
<body>

    <h1>SCANNER DE CONTRÃ”LE 2026</h1>
    <div id="loading">Chargement de la base de donnÃ©es...</div>
    
    <button id="startBtn" style="display:none;">ðŸ“· CLIQUEZ ICI POUR SCANNER</button>

    <div id="reader"></div>

    <div id="result">
        <div class="member-name" id="nameDisplay"></div>
        <div class="status-text" id="statusDisplay"></div>
        <div class="passage-info" id="passageDisplay"></div>
    </div>

    <script>
        // 1. LIEN DE VOTRE BASE DE DONNÃ‰ES
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSc3LZw98cFyqm2XGSEYYF3IOf5fHB3Pff8vLLlCD-VgvIicvX6jYWH-QDSbn5dZvpPhHjrXoIH4Hu9/pub?gid=0&single=true&output=csv'; 
        
        // 2. LIEN DE VOTRE SCRIPT (COPIER-COLLER LE LIEN /exec ICI)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwDMSA_TrLhZkdup_V7GkzS_upZ_PenHKg_NTTyQB18JKppMYgNAm47xN-L68u1BrK/exec'; 

        let membersData = [];
        let isProcessing = false; // EmpÃªche les scans multiples trop rapides

        function loadDatabase() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    membersData = results.data;
                    document.getElementById('loading').innerText = "âœ… " + membersData.length + " membres chargÃ©s";
                    document.getElementById('startBtn').style.display = 'inline-block';
                }
            });
        }

        document.getElementById('startBtn').addEventListener('click', function() {
            this.style.display = 'none';
            startScanner();
        });

        function startScanner() {
            const html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => { alert("Erreur camÃ©ra : " + err); });
        }

        async function onScanSuccess(decodedText) {
            if (isProcessing) return; // Si on est dÃ©jÃ  en train d'enregistrer, on ignore
            isProcessing = true;

            const member = membersData.find(m => m.Codice_QR && m.Codice_QR.trim() === decodedText.trim());
            const resultDiv = document.getElementById('result');
            const passageDisplay = document.getElementById('passageDisplay');
            
            resultDiv.style.display = 'block';
            passageDisplay.innerText = "Enregistrement en cours...";

            if (member) {
                const nome = member.Nome;
                const cognome = member.Cognome;
                const status = member.Stato ? member.Stato.toUpperCase() : "INCONNU";

                document.getElementById('nameDisplay').innerText = nome + " " + cognome;
                document.getElementById('statusDisplay').innerText = status;
                resultDiv.className = (status === "ATTIVO") ? 'attivo' : 'inattivo';

                // --- ENVOI DES DONNÃ‰ES AU GOOGLE SCRIPT ---
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Important pour Google Script
                        cache: 'no-cache',
                        body: JSON.stringify({ qr: decodedText.trim() })
                    });
                    
                    // Comme on est en 'no-cors', on ne peut pas lire la rÃ©ponse JSON, 
                    // mais le script s'exÃ©cute quand mÃªme cÃ´tÃ© Google.
                    passageDisplay.innerText = "âœ… Passage enregistrÃ© & Email envoyÃ©";
                } catch (error) {
                    console.error(error);
                    passageDisplay.innerText = "âŒ Erreur d'enregistrement";
                }

            } else {
                resultDiv.className = '';
                resultDiv.style.background = '#333';
                document.getElementById('nameDisplay').innerText = "MEMBRE NON TROUVÃ‰";
                document.getElementById('statusDisplay').innerText = "Code: " + decodedText;
                passageDisplay.innerText = "";
            }

            // Attendre 3 secondes avant de permettre un nouveau scan
            setTimeout(() => { isProcessing = false; }, 3000);
        }

        window.onload = loadDatabase;
    </script>
</body>
</html>
